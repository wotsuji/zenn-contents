---
title: "ï¼ˆæ‚ªç”¨å³ç¦ï¼‰OSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ã‚’æ¤œè¨¼ã™ã‚‹PHPã‚³ãƒ¼ãƒ‰"
emoji: "ğŸ‘"
type: "tech"
topics: ["php", "ubuntu", "apache", "è„†å¼±æ€§", "osã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³"]
published: true
---

# æ¦‚è¦
å­¦ç¿’ç”¨ã¨ã—ã¦**OSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§**ã‚’å®Ÿéš›ã«å‹•ã‹ã—ã¦æ¤œè¨¼ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
**å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’è©¦ã™å ´åˆã¯å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã—ã‹æ¥ç¶šã§ããªã„ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚**
:::message alert
å¤–éƒ¨ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒã§è©¦ã™ã¨ã€ç¬¬ä¸‰è€…ãŒOSã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡ŒãŒå¯èƒ½ã¨ãªã£ã¦ã—ã¾ã†ãŸã‚æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
:::
# ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ï¼ˆApacheï¼‹PHPï¼‰
ä»Šå›ã®æ¤œè¨¼ã¯Windows10ã«WSL2ã§Apacheï¼‹PHPã®ç’°å¢ƒã‚’ä½œæˆã—ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
> æ¤œè¨¼ç’°å¢ƒï¼šUbuntu 20.04.2 LTSï¼ˆWSL2ï¼‰ + Apache 2.4.41 ï¼‹ PHP 7.4.3
```php:os_cmd_injection_test.php
/**
 * ã€æ‚ªç”¨å³ç¦ã€‘
 * è¡¨é¡Œï¼šOSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆPHPï¼‰
 * èª¬æ˜ï¼šOSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®PHPãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚
 * æ¦‚è¦ï¼šãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚µãƒ–ãƒŸãƒƒãƒˆã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘å–ã‚ŠOSã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’è¡¨ç¤ºã™ã‚‹ã€‚
 */

// OSã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
$exec_cmd = "";
if ( isset($_POST['exec_cmd']) ) {
  $exec_cmd = $_POST['exec_cmd'];
  ob_start();
  passthru($exec_cmd);
  $cmd_result = ob_get_contents();
  ob_end_clean();
  $cmd_result = nl2br($cmd_result);
}

// ç”»é¢è¡¨ç¤ºï¼ˆHTMLï¼‰
$html =<<<__EOL__
<!DOCTYPE html>
<html>
<head>
</head>
<body>
<h1>OS Command Injection Test Program</h1>
<div>---- Input Command To Submit----</div>
<div>
<form method="post">
<input type="text" name="exec_cmd"></input><br />
<input type="submit" value="submit"></input>
</form>
</div>
<br />
<div>---- Exec OS Cmd ----</div>
<div>
$exec_cmd<br />
</div>
<div>---- OS Cmd Result ----</div>
<div>
$cmd_result
</div>
</body>
</html>
__EOL__;

header("Content-type: text/html; charset=UTF-8");
echo $html;
```
ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡ŒçµæœãŒå…¨ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«[passthru()](https://www.php.net/manual/ja/function.passthru.php)é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
[passthru()](https://www.php.net/manual/ja/function.passthru.php)ã¯ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒçµæœãŒæ¨™æº–å‡ºåŠ›ã«æ›¸ãå‡ºã•ã‚Œã‚‹ãŸã‚[ob_start()](https://www.php.net/manual/ja/function.ob-start.php)ã‚’ä½¿ã£ã¦æ¨™æº–å‡ºåŠ›ã‚’ãƒãƒƒãƒ•ã‚¡ã—ã¦åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚OSã‚³ãƒãƒ³ãƒ‰ã¯POSTã®æœ‰ç„¡ã§å®Ÿè¡Œã•ã›ã¾ã™ã€‚
# å®Ÿè¡Œçµæœã‚µãƒ³ãƒ—ãƒ«
**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ï¼šapache2 -v**
![](https://storage.googleapis.com/zenn-user-upload/55rcc6euxtp7sk8p0eqle8x79fds)
**å®Ÿè¡Œçµæœï¼šsubmitå®Ÿè¡Œå¾Œ**
![](https://storage.googleapis.com/zenn-user-upload/aw34imzdkt33p5jauanf6wbcaj16)
è¦‹äº‹ã«OSã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã‚’è¡¨ç¤ºã•ã›ã‚‹äº‹ãŒã§ãã¾ã—ãŸã€‚
# PHPã§å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®Ÿè¡Œå¯èƒ½ãªä¸»ãªé–¢æ•°
PHPã¯å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®Ÿè¡Œã§ãã‚‹é–¢æ•°ãŒå¤šæ•°ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã®ã§[passthru()](https://www.php.net/manual/ja/function.passthru.php)ä»¥å¤–ã«ã‚‚æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
> [exec()](https://www.php.net/manual/ja/function.exec.php)
> ã€€ã‚³ãƒãƒ³ãƒ‰çµæœã®æœ€å¾Œã®è¡Œã‚’è¿”ã—ã¾ã™ã€‚
> [system()](https://www.php.net/manual/ja/function.system.php)
> ã€€æˆåŠŸæ™‚ã¯ã‚³ãƒãƒ³ãƒ‰å‡ºåŠ›ã®æœ€å¾Œã®è¡Œã‚’è¿”ã—ã€å¤±æ•—æ™‚ã¯ false ã‚’è¿”ã—ã¾ã™ã€‚
> [passthru()](https://www.php.net/manual/ja/function.passthru.php)
> ã€€ä¸€åˆ‡å¹²æ¸‰ã‚’å—ã‘ãšã«ç›´æ¥ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘ã¨ã‚‹ã€‚
> ...

â€»ä»–ã«ã‚‚PHPã®å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã¯å­˜åœ¨ã™ã‚‹ãŸã‚è¦ç¢ºèªã®ã“ã¨
# OSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
**å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚‹é–¢æ•°ã‚’åˆ©ç”¨ã™ã‚‹éš›ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚**
â€»ã‚ãã¾ã§å€‹äººçš„ãªç§è¦‹ã§ã™ã€‚
ï¼‘ï¼**å¤–éƒ¨ã‹ã‚‰æ¸¡ã•ã‚ŒãŸå€¤ã‚’å®Ÿè¡Œã—ãªã„æ§‹é€ **ã«ã™ã‚‹ã€‚
ï¼’ï¼å¤–éƒ¨ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’æ¸¡ã—ã¦å®Ÿè¡Œã•ã›ã‚‹å ´åˆã¯ã€**æŒ‡å®šã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ä»¥å¤–ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹**ã€‚
ï¼“ï¼ã•ã‚‰ã«ã€Œ;ã€ã«ã‚ˆã‚‹é€£ç¶šã‚³ãƒãƒ³ãƒ‰ ã€Œ>ã€ã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—ãªã©**ç‰¹æ®Šè¨˜å·ã‚’è€ƒæ…®ã™ã‚‹**ã€‚
ã€€ã€Œ;ã€ã€Œ>ã€ã€Œ<ã€ã€Œ|ã€ã€Œ&ã€ã€Œ`ã€ã€Œ(ã€ã€Œ)ã€ã€Œ$ã€ã€Œ*ã€ã€Œ?ã€ã€Œ{ã€ã€Œ}ã€ã€Œ[ã€ã€Œ]ã€ã€Œ!ã€ãªã©ã€‚
ï¼”ï¼åˆ¥ã®è„†å¼±æ€§ã«ã‚ˆã‚Š**ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒè¡Œã‚ã‚ŒãŸ**å ´åˆã«OSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒæ··å…¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€Œ**æ”¹ã–ã‚“æ¤œçŸ¥**ã€**ã‚’æ¤œè¨ã™ã‚‹ã€‚**
ï¼•ï¼**ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆWEBã‚µãƒ¼ãƒã®å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®æ¨©é™ã‚’æœ€ä½é™ã«ã™ã‚‹**ã€‚
# ã¾ã¨ã‚
**OSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§**ã¯OSãƒ¬ãƒ™ãƒ«ã®æ“ä½œãŒå¯èƒ½ã¨ãªã‚‹ãŸã‚éå¸¸ã«å±é™ºãªè„†å¼±æ€§ã§ã™ã€‚**ApacheãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§å¯èƒ½ãªäº‹ãŒãªã‚“ã§ã‚‚ã§ãã¦ã—ã¾ã†**ãŸã‚**SSHã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã•ã‚Œã¦ã„ã‚‹äº‹ã«ç­‰ã—ã„**ã¨è¨€ãˆã¾ã™ã€‚
ã¾ãŸã‚³ãƒ¼ãƒ‰ã«è„†å¼±æ€§ã‚’ä½œã‚Šè¾¼ã¾ãªã„ã‚ˆã†ã«æ³¨æ„ã™ã‚‹ã ã‘ã§ã¯ãªãã€ä»–ã®è„†å¼±æ€§ã«ã‚ˆã‚Š**ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ãŒè¡Œã‚ã‚Œã‚‹äº‹ã«ã‚ˆã‚Š**OSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ãŒæ··å…¥ã•ã‚Œã¦ã„ãäº‹ã«å¯¾ã™ã‚‹å¯¾ç­–ã‚‚æ¤œè¨ã—ã¦ã„ã**å¿…è¦ãŒã‚ã‚‹ã¨è€ƒãˆã¾ã™ã€‚
**è„†å¼±æ€§ã¯çŸ¥ã‚‰ãªã„ã§ã¯æ¸ˆã¾ã•ã‚Œãªã„**ãŸã‚ä»•æ§˜é€šã‚Šã«å‹•ãã‚³ãƒ¼ãƒ‰ã‚’ä½œã‚‹ã ã‘ã§ã¯ãªãã€ã‚»ã‚­ãƒ¥ã‚¢ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããŸã‚ã®å‹‰å¼·ã‚‚ä¸¦è¡Œã™ã‚‹å¿…è¦æ€§ã‚’æ„Ÿã˜ã¾ã™ã€‚

ä»¥ä¸Šã€OSã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ã‚’æ¤œè¨¼ã™ã‚‹PHPã‚³ãƒ¼ãƒ‰ã§ã—ãŸã€‚ã‚ãã¾ã§å­¦ç¿’ç”¨ã¨ã—ã¦æ‚ªç”¨å³ç¦ã«ã¦ãŠé¡˜ã„ã—ã¾ã™ï¼ï¼
